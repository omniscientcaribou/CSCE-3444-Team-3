<!DOCTYPE html>

<html>
<head>
  <sript src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>

<body>
  <h1>mFinance2</h1>
  <button id="gross" onclick="sum()">TOTAL GROSS SALES</button><br><br>
  <div class="menu" style="display: block;">
    <table>
      <thead id="countTableHead">
        <tr>
          <th>Menu Item</th>
          <th>Price</th>
          <th>Number Sold</th>
          <th>Total</th>
        </tr>
      </thead>

      <tbody id="countTableBody">
      </tbody>
    </table>
  </div>

  <script>
    let total = 0;
    let prices = [];
    let quantities = [];

  window.onload = function retrieve() {
    total = 0;
      fetch("https://swe3444.herokuapp.com/api/ordercontent/", {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => {
        // console.log(response);
        return response.json();
      })
      .then(data => {
        console.log(data);

        const url2 = "https://swe3444.herokuapp.com/api/item/";
        fetch(url2, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response2 => {
          return response2.json();
        })
        .then(data2 => {
          // console.log('item id: ',data2.id,'item name: ', data2.name, 'item price: ', data2.price);
          // prices.push(data2.price);
          // quantities.push(data2.quantity);
          console.log(data2);
            data.forEach(content => {
                if (content.state === "PAID") {
                    var menuItem = data2.find(element => element.id === content.item);
                    // console.log(menuItem);
                    total += Number(menuItem.price) * Number(content.quantity);
                }
            });
            total = total.toFixed(2);
            countTable(data, data2);
      })
    })

    function countTable(contentList, itemList) {
      var tableBody = document.getElementById('countTableBody');
      var filtered = [...new Set(contentList.map(m => {
        if(m.state === 'PAID'){
          return itemList.find(element => element.id === m.item).id;
        }
        // else {
        //   return ;
        // }
      }))].filter(f => f!== undefined);

      // filtered.sort();
      console.log(filtered);
      filtered.forEach((content) => {

            // var menuItem = itemList.find(element => element.id === content.item);
            let countTableRow = document.createElement('tr');
            let name = document.createElement('td');
            // name.id = i + ".0";
            // console.log(itemList.find(element => element.id === content));
            name.innerText = itemList.find(element => element.id === content).name;
            let price = document.createElement('td');
            // price.id = i + ".1";
            price.innerText = itemList.find(element => element.id === content).price;
            let count = document.createElement('td');
            let filteredContent = contentList.filter(f => {
              if(f.state === 'PAID' && f.item === content) {
                return f;
              } else {
                return;
              }}).map(m => m.quantity);
            // count.innerText = contentList.filter(f => {
            //   if(f.state === 'PAID' && f.item === content) {
            //     return f.quantity;
            //   } else {
            //     return;
            //   }
            console.log(filteredContent);
            count.innerText = filteredContent.reduce((a,b) => Number(a) + Number(b));
            // count.id = i + ".2";
            let total = document.createElement('td');
            total.innerText = Number(price.innerText) * Number(count.innerText);
            // total.id = i + ".3";
            // countTableRow.id = i;
            // Append the current row to countTableBody
            countTableRow.append(name, price, count, total);
            tableBody.append(countTableRow);

        });


    }
}

    function sum(){
      alert(`PAID items total: \$${total}`);
    }

  </script>
</body>

</html>
